version: "3"

# extension field: https://docs.docker.com/compose/compose-file/compose-file-v3/#extension-fields
x-networks: &networks
  networks:
    - cdtcloud-network

x-cache-from: &cache-from
  cache_from:
    - cdtcloud/cdtcloud-arduino-cli:${DOCKER_IMAGE_TAG:-main}
    - cdtcloud/cdtcloud-device-connector:${DOCKER_IMAGE_TAG:-main}
    - cdtcloud/cdtcloud-deployment-server:${DOCKER_IMAGE_TAG:-main}
    - cdtcloud/cdtcloud-theia:${DOCKER_IMAGE_TAG:-main}
    - cdtcloud/cdtcloud-demo:${DOCKER_IMAGE_TAG:-main}

x-shared-conf: &shared-conf
  <<: *networks

services:
  db:
    <<: *networks
    profiles:
      - deployment
      - demo
    image: postgres:14-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: dev
      POSTGRES_DB: deploymentdb
    ports:
      - "5432:5432"
    volumes:
      - postgresdb:/var/lib/postgresql/data
    restart: unless-stopped

  arduino-cli:
    <<: *shared-conf
    profiles:
      - connector
    image: cdtcloud/cdtcloud-arduino-cli:${DOCKER_IMAGE_TAG:-main}
    build:
      context: .
      dockerfile: Dockerfile
      target: arduino-cli
      <<: *cache-from
    ports:
      - "50051:50051"
    volumes:
      - connector:/cdtcloud/device-connector/artifacts:ro
    privileged: true
    restart: unless-stopped

  device-connector:
    <<: *shared-conf
    profiles:
      - connector
    image: cdtcloud/cdtcloud-device-connector:${DOCKER_IMAGE_TAG:-main}
    env_file:
      - .docker/device-connector/env
    build:
      context: .
      dockerfile: Dockerfile.test
      target: device-connector
      <<: *cache-from
    volumes:
      - connector:/cdtcloud/device-connector
    restart: unless-stopped

  deployment-server:
    <<: *shared-conf
    profiles:
      - deployment
    image: cdtcloud/cdtcloud-deployment-server:${DOCKER_IMAGE_TAG:-main}
    env_file:
      - .docker/deployment-server/env
    build:
      context: .
      dockerfile: Dockerfile.test
      target: deployment-server
      <<: *cache-from
    depends_on:
      - db
    ports:
      - "3001:3001"
    volumes:
      - deployment:/cdtcloud/deployment-server
    restart: unless-stopped

  theia:
    <<: *shared-conf
    profiles:
      - theia
    image: cdtcloud/cdtcloud-theia:${DOCKER_IMAGE_TAG:-main}
    env_file:
      - .docker/theia/env
    build:
      context: .
      dockerfile: Dockerfile.test
      target: cdtcloud-theia
      <<: *cache-from
    ports:
      - "3000:3000"
    volumes:
      - theia:/cdtcloud/theia
      - theia:/cdtcloud/project
    restart: unless-stopped

  demo:
    <<: *shared-conf
    profiles:
      - demo
    image: cdtcloud/cdtcloud-demo:${DOCKER_IMAGE_TAG:-main}
    environment:
      NODE_ENV: "demo"
      DATABASE_URL: "postgresql://postgres:dev@db:5432/deploymentdb?schema=public"
    build:
      context: .
      dockerfile: Dockerfile
      target: demo
      <<: *cache-from
    ports:
      - "3000:3000"
      - "3001:3001"
    privileged: true
    depends_on:
      - db
    volumes:
      - deployment:/deployment-server
      - deployment:/public
      - connector:/device-connector
      - theia:/theia
      - theia:/project
    restart: on-failure

volumes:
  postgresdb:
  connector:
  deployment:
  theia:

networks:
  cdtcloud-network:
  cli-network:
